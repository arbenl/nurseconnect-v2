rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helpers ---
    function isAuthed() {
      return request.auth != null;
    }

    // Token shape used by Auth Emulator for project "demo-nurseconnect"
    function isEmulatorProject() {
      return request.auth != null
        && request.auth.token.aud == "demo-nurseconnect"
        && request.auth.token.iss.matches("https://securetoken.google.com/demo-nurseconnect");
    }

    // --- USERS: allow creating own user doc during emulator tests ---
    match /users/{uid} {
      // During emulator tests, allow the authed (emulated) user to create their own profile doc.
      allow create: if isEmulatorProject() && isAuthed() && request.auth.uid == uid;

      // Your normal prod rules should remain as-is below.
      // Example (tight) prod rules:
      allow read, update: if isAuthed() && request.auth.uid == uid;
      // allow create in prod only via server or with stricter checks, etc.
    }

    // Test-only collections (emulator)
     match /test_only/{docId} {
      allow read, write: if request.auth != null;
    }

    // ... keep the rest of your production rules here ...
  }
}
